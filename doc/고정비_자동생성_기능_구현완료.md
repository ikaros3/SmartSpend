# 고정비/변동비 자동 생성 기능 구현 완료

## 📅 구현 일자
2026-01-27

## 🎯 구현 목표
매월 초 자동으로 고정비 항목을 생성하는 기능 구현
- 사용자가 설정 화면에서 고정비 템플릿을 관리
- 새로운 달이 시작되면 활성화된 고정비 템플릿 기반으로 지출 항목 자동 생성
- Firestore에 고정비 템플릿 저장 및 동기화

## ✅ 구현 완료 항목

### 1. 유틸리티 파일 생성
**파일**: `src/utils/fixedExpenseHelper.js`

**주요 기능**:
- 기본 고정비 템플릿 7개 정의 (생활비, 용돈 2개, 대출상환 3개, 세금/공과금 1개)
- 분류별 색상 매핑 (생활비: 파랑, 용돈: 초록, 대출상환: 주황, 세금/공과금: 보라)
- 날짜 관련 유틸 함수:
  - `isNewMonth()`: 새로운 달로 넘어갔는지 확인
  - `getCurrentMonthDateString()`: 현재 월의 특정 일자 문자열 생성
  - `getDateForMonth()`: 31일이 없는 달 처리
- 고정비 생성 관련 함수:
  - `createExpenseFromTemplate()`: 템플릿으로부터 지출 항목 생성
  - `isFixedExpenseAlreadyCreated()`: 중복 생성 방지 체크

### 2. Firestore 서비스 확장
**파일**: `src/services/firestoreService.js`

**추가된 함수**:
```javascript
// 고정비 템플릿 저장
saveFixedExpenseTemplates(userId, templates)

// 고정비 템플릿 로드
loadFixedExpenseTemplates(userId)
```

**데이터 구조**:
```javascript
budgets/{userId}
  ├─ dbData: {...}
  ├─ categories: [...]
  └─ fixedExpenseTemplates: [
      {
        id: "uuid",
        category: "생활비",
        description: "생활비(효원)",
        amount: 4000000,
        dayOfMonth: 1,
        isActive: true,
        createdAt: "2026-01-27T...",
        updatedAt: "2026-01-27T..."
      }
    ]
```

### 3. 고정비 관리 모달 컴포넌트
**파일**: `src/components/modals/FixedExpenseModal.jsx`

**주요 기능**:
- ✅ 고정비 템플릿 목록 표시 (카드 형태)
- ✅ 새 고정비 추가 폼
  - 분류 선택 (드롭다운)
  - 내용 입력
  - 금액 입력
  - 매월 날짜 선택 (1-31일)
- ✅ 기존 고정비 수정
- ✅ 고정비 삭제
- ✅ 활성화/비활성화 토글
- ✅ 기본 템플릿으로 초기화 버튼

**UI 특징**:
- 그라데이션 헤더 (초록색)
- 분류별 색상 배지
- 반응형 디자인
- 직관적인 아이콘 사용

### 4. BudgetContext 확장
**파일**: `src/context/BudgetContext.jsx`

**추가된 상태**:
```javascript
const [fixedExpenseTemplates, setFixedExpenseTemplates] = useState([]);
const [isFixedExpenseModalOpen, setIsFixedExpenseModalOpen] = useState(false);
```

**추가된 함수**:
- `checkAndGenerateMonthlyExpenses()`: 매월 자동 생성 체크 및 실행
- `handleSaveFixedExpenseTemplate()`: 템플릿 저장/수정
- `handleDeleteFixedExpenseTemplate()`: 템플릿 삭제
- `handleToggleFixedExpenseActive()`: 활성화/비활성화 토글
- `handleInitializeDefaultTemplates()`: 기본 템플릿으로 초기화

**자동 생성 로직**:
1. 앱 초기화 시 `checkAndGenerateMonthlyExpenses()` 실행
2. localStorage의 `lastFixedExpenseCheck` 확인
3. 새로운 달이면:
   - 활성화된 고정비 템플릿 로드
   - 각 템플릿에 대해 지출 항목 생성
   - 중복 체크 (같은 날짜, 같은 내용)
   - Firestore에 저장
   - Toast 알림 표시
4. `lastFixedExpenseCheck` 업데이트

### 5. 설정 화면 연동
**파일**: `src/components/views/SettingsView.jsx`

**변경 사항**:
- "고정비/변동비 기준 설정" 메뉴에 클릭 이벤트 추가
- `onClick={() => setIsFixedExpenseModalOpen(true)}`

### 6. App.jsx 통합
**파일**: `src/App.jsx`

**변경 사항**:
- FixedExpenseModal import
- Context에서 고정비 관련 상태 및 함수 가져오기
- FixedExpenseModal 렌더링 및 props 전달

## 🔄 자동 생성 프로세스

```
앱 시작
  ↓
localStorage 확인
  ↓
새로운 달? ──No──→ 종료
  ↓ Yes
고정비 템플릿 로드
  ↓
활성화된 템플릿 필터링
  ↓
각 템플릿 순회
  ↓
중복 체크 ──Yes──→ 다음 템플릿
  ↓ No
지출 항목 생성
  ↓
dbData에 추가
  ↓
Firestore 저장
  ↓
Toast 알림
  ↓
lastFixedExpenseCheck 업데이트
```

## 📊 기본 고정비 템플릿

| 분류 | 내용 | 금액 | 날짜 |
|------|------|------|------|
| 생활비 | 생활비(효원) | 4,000,000원 | 매월 1일 |
| 용돈 | 규리 | 1,000,000원 | 매월 25일 |
| 용돈 | 시연 | 800,000원 | 매월 25일 |
| 대출상환 | 담보대출(0.8억) | 350,000원 | 매월 27일 |
| 대출상환 | 담보대출(1억) | 350,000원 | 매월 27일 |
| 대출상환 | 보금자리론(1.2억) | 350,000원 | 매월 30일 |
| 세금/공과금 | 건강보험료(지역) | 177,450원 | 매월 10일 |

## 🎨 UI/UX 특징

### 색상 테마
- **생활비**: 파란색 (#3B82F6)
- **용돈**: 초록색 (#10B981)
- **대출상환**: 주황색 (#F59E0B)
- **세금/공과금**: 보라색 (#8B5CF6)
- **기타**: 회색 (#6B7280)

### 모달 레이아웃
- 전체 화면 모달 (최대 너비 2xl)
- 그라데이션 헤더 (초록색)
- 카드 형태의 템플릿 목록
- 슬라이드 인 형태의 추가/수정 폼
- 하단 안내 메시지

## 🔍 테스트 가이드

### 1. 고정비 템플릿 관리 테스트
1. 설정 탭으로 이동
2. "고정비/변동비 기준 설정" 클릭
3. "기본 고정비 템플릿으로 초기화" 클릭
4. 7개의 기본 템플릿이 생성되는지 확인
5. 새 고정비 추가 테스트
6. 기존 고정비 수정 테스트
7. 고정비 삭제 테스트
8. 활성화/비활성화 토글 테스트

### 2. 자동 생성 테스트
**방법 1: localStorage 조작**
```javascript
// 개발자 도구 콘솔에서 실행
localStorage.setItem('lastFixedExpenseCheck', '2026-01-01T00:00:00.000Z');
// 페이지 새로고침
```

**방법 2: 실제 월 변경 대기**
- 월말에 앱을 사용하고 다음 달 1일에 다시 접속
- 자동으로 고정비가 생성되는지 확인

### 3. 중복 방지 테스트
1. 같은 달에 자동 생성 로직을 여러 번 실행
2. 같은 고정비가 중복 생성되지 않는지 확인

### 4. Firestore 동기화 테스트
1. 고정비 템플릿 추가/수정/삭제
2. Firestore 콘솔에서 데이터 확인
3. 다른 기기에서 로그인하여 동기화 확인

## ⚠️ 주의사항

### 날짜 처리
- 31일이 없는 달(2월, 4월, 6월, 9월, 11월)의 경우 해당 월의 마지막 날로 자동 조정
- 예: 2월에 31일 고정비는 2월 28일(또는 29일)에 생성

### 중복 방지
- `description`과 `dateKey`로 중복 체크
- `isFixedExpense: true` 플래그로 자동 생성 항목 표시

### 타임존
- 사용자의 로컬 타임존 기준으로 날짜 판단
- `new Date().toISOString()` 사용

### 성능
- 자동 생성은 앱 초기화 시 1회만 실행
- Firestore 호출 최소화 (배치 저장)

## 🐛 알려진 이슈 및 제한사항

1. **시간대 문제**: 서버 시간과 클라이언트 시간이 다를 경우 날짜 판단에 차이 발생 가능
2. **오프라인 모드**: 오프라인 상태에서는 자동 생성이 실행되지 않음
3. **브라우저 캐시**: localStorage 기반이므로 브라우저 캐시 삭제 시 마지막 체크 날짜 초기화

## 🔮 향후 개선 사항

1. **알림 기능**: 고정비 생성 전 사용자에게 알림
2. **예외 처리**: 특정 월에만 제외하는 기능
3. **반복 패턴**: 격월, 분기별 등 다양한 반복 패턴 지원
4. **금액 변동**: 특정 월에 금액 변경 기능
5. **카테고리 자동 매핑**: 기존 카테고리와 자동 연동

## 📝 코드 변경 요약

### 새로 생성된 파일 (2개)
- `src/utils/fixedExpenseHelper.js` (171줄)
- `src/components/modals/FixedExpenseModal.jsx` (293줄)

### 수정된 파일 (4개)
- `src/services/firestoreService.js` (+48줄)
- `src/context/BudgetContext.jsx` (+145줄)
- `src/components/views/SettingsView.jsx` (+4줄)
- `src/App.jsx` (+20줄)

**총 추가 코드**: 약 681줄

## 🎉 완료!

고정비/변동비 자동 생성 기능이 성공적으로 구현되었습니다. 
사용자는 이제 설정 화면에서 고정비 템플릿을 관리할 수 있으며, 
매월 자동으로 고정비 항목이 생성됩니다.
